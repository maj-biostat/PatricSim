---
title: "PATRIC Simulation Results"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)


suppressPackageStartupMessages(library(dplyr))
suppressPackageStartupMessages(library(tidyr))
suppressPackageStartupMessages(library(ggplot2))
suppressPackageStartupMessages(library(knitr))
suppressPackageStartupMessages(library(kableExtra))
suppressPackageStartupMessages(library(psych))
suppressPackageStartupMessages(library(grid))
suppressPackageStartupMessages(library(gridExtra))
suppressPackageStartupMessages(library(DT))
suppressPackageStartupMessages(library(htmltools))


ggplot2::theme_set(ggplot2::theme_bw())
ggplot2::theme_update(text = element_text(size = 10))
ggplot2::theme_update(legend.position = "top")
# ggplot2::theme_update(legend.title = element_blank())
ggplot2::theme_update(axis.text.x = element_text(size = 10))
ggplot2::theme_update(axis.text.y = element_text(size = 10))

```

```{r, include=FALSE}



dsup <- data.frame()
dni <- data.frame()

drecov <- data.frame()
dbias <- data.frame()

dtrue_mu <- data.frame()

fout <- list.files("out10a")

for(i in 1:length(fout)){
  l <- readRDS(paste0("out10a/", fout[i]))
  
  # superiority data

  # test whether max is superior to all other doses
  dtmp <- cbind(l$dsup, apply(l$dsup[, 1:ncol(l$dsup)], 2, function(x){ x > 0.9}))
  
  n_doses <- length(l$trtgrps$trtgrps$dose)
  doses <- l$trtgrps$trtgrps$dose
  min_dose <- min(l$trtgrps$trtgrps$dose)
  max_dose <- max(l$trtgrps$trtgrps$dose)
  
  tmp <- c(scenario = l$scenario, 
           range = l$trtgrps$p_range,
           n_doses = n_doses,
           min_dose = min_dose,
           max_dose = max_dose,
           n_per_trt = l$n_per_trt,
           colMeans(dtmp[, n_doses:ncol(dtmp)]))
  
  # eta columns are the proportion of times that the proportion that recovered on max
  # duration was greater than the proportion recovered on the 1 day, 2 days, 3 days etc
  dsup <- rbind(dsup, tmp)
  
  names(dsup) <- names(tmp)
  names(dsup)[(ncol(dsup)-n_doses+2):ncol(dsup)] <- paste0("D", doses[-length(doses)])
  
  # non-inferiority
  # dtmp <- cbind(l$dni, apply(l$dni[, 1:ncol(l$dni)], 2, mean))
  
  dtmp <- cbind(l$dni, apply(l$dni[, 1:ncol(l$dni)], 2, function(x){ x > 0.6}))
  
  tmp <- c(scenario = l$scenario, 
           range = l$trtgrps$p_range,
           n_doses = n_doses,
           min_dose = min_dose,
           max_dose = max_dose,
           n_per_trt = l$n_per_trt,
           colMeans(dtmp[, n_doses:ncol(dtmp)]))
  
  # eta columns are the proportion of times that the proportion that recovered on max
  # duration was non-inferior to the proportion recovered on the 1 day, 2 days, 3 days etc
  dni <- rbind(dni, tmp)
  
  names(dni) <- names(tmp)
  names(dni)[(ncol(dni)-n_doses+2):ncol(dni)] <- paste0("D", doses[-length(doses)])
  
  # prob recovery
  tmp <- c(scenario = l$scenario, 
           range = l$trtgrps$p_range,
           n_doses = n_doses,
           min_dose = min_dose,
           max_dose = max_dose,
           n_per_trt = l$n_per_trt,
           colMeans(l$dprob))
  
  drecov <- rbind(drecov, tmp)
  names(drecov) <- names(tmp)
  names(drecov)[(ncol(drecov)-n_doses+1):ncol(drecov)] <- paste0("D", doses)
  
  tmp <- cbind(scenario = l$scenario, 
           range = l$trtgrps$p_range,
           n_doses = n_doses,
           min_dose = min_dose,
           max_dose = max_dose,
           dose = l$trtgrps$trtgrps$dose,
    true_mu = l$trtgrps$trtgrps$true_mu
  )
  
  dtrue_mu <- rbind(dtrue_mu, tmp)

  
  # bias
  tmp <- c(scenario = l$scenario, 
           range = l$trtgrps$p_range,
           n_doses = n_doses,
           min_dose = min_dose,
           max_dose = max_dose,
           n_per_trt = l$n_per_trt,
           colMeans(l$dbias))
  
  dbias <- rbind(dbias, tmp)
  names(dbias) <- names(tmp)
  names(dbias)[(ncol(dbias)-n_doses+1):ncol(dbias)] <- paste0("D", doses)
  
}

rownames(dsup) <- NULL
rownames(dni) <- NULL



```



## Recovering Parameters

```{r, echo = F, eval = T}
digits <- c(0, 1, 0, 0, 0, 0,
            rep(2, n_doses)
            )

comparison_names <- paste0(doses, " days")

kable(drecov,
      caption = paste0("Table. Simulation Results (", nrow(drecov), " rows)"),
      col.names = c("Scenario", "Range", "n(dose)", "min(dose)", "max(dose)",  "n_per_arm", 
                    comparison_names),
      digits = digits) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = F, position = "left",
                font_size = 12,
                latex_options = "hold_position") 

```

The figure below shows the estimated (black) proportion recovered and true proportion recovered (red).

```{r, echo = F, fig.width=5.5, fig.height=3.5, fig.cap="Estimated and true probability of recovery", fig.align="center"}

dfig1 <- drecov %>%
  dplyr::select(-max_dose, -min_dose, -n_doses) %>%
  tidyr::gather("dose", "precov", -range, -scenario, -n_per_trt) %>%
  dplyr::arrange(scenario, dose) %>%
  dplyr::mutate(dose = gsub("D", "", dose), 
    dose = as.numeric(dose))

ggplot(dfig1, aes(x = dose, y = precov, group = scenario))+
  geom_line() +
  geom_point() +
  geom_point(data = dtrue_mu, 
    aes(x = dose, y = true_mu, group = scenario), col = "red") +
  scale_y_continuous("Pr(recov)", lim = 0:1) +
  scale_x_continuous("Days", breaks = c(0, 2, 4, 6, 8, 10)) +
  facet_wrap(.~ paste0("Pr. range ", range ))

```




## Bias

```{r, echo = F, eval = T}
digits <- c(0, 1, 0, 0, 0, 0,
            rep(2, n_doses)
            )

comparison_names <- paste0(doses, " days")

kable(dbias,
      caption = paste0("Table. Simulation Results (", nrow(dbias), " rows)"),
      col.names = c("Scenario", "Range", "n(dose)", "min(dose)", "max(dose)",  "n_per_arm", 
                    comparison_names),
      digits = digits) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = F, position = "left",
                font_size = 12,
                latex_options = "hold_position") 

```


## Superiority

The columns with "10 Days versus x days" show the proportion of times that the probability of recovery on the maximum duration antibiotic was found to be higher than the probability of recovery on the 1 day, 2 days, 3 days etc. In these examples we used a 90% decision threshold, i.e. those with $Pr(\pi_{max(d)} > \pi_i) > 0.9$ where $\pi_k$ is the probability (or proportion) recovered on dose $d$ and $d \in \{0, 1, \dots, 10\}$.

Range gives the range in underlying true recovery probability with a lower bound of 0.5 in all scenarios. For example, a range equal to 0.3 implies that we generate data from parameter values from 0.5 to 0.8.


```{r, echo = F, eval = T}
digits <- c(0, 1, 0, 0, 0, 0,
            rep(2, n_doses-1)
            )

comparison_names <- paste0(doses[-length(doses)], " days")

kable(dsup,
      caption = paste0("Table. Simulation Results (", nrow(dsup), " rows)"),
      col.names = c("", "", "doses", "min", "max", "n_per_trt",
                    comparison_names),
      digits = digits) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = F, position = "left",
                font_size = 12,
                latex_options = "hold_position")  %>%
  add_header_above(c("Scenario" = 1, "Range" = 1, 
                     "N"=1, "Dose"=2, 
                     "N" = 1,
    "Max duration versus" = n_doses-1))

```

## Equivalence

Analogous to above but here we examine equivalence. Equivalence is determined by setting an equivalence threshold and testing that a large proportion of the probability mass of the difference between proportion recovered is within this equivalence threshold. See design doc for further explanation.

Here we show proportion of times that the probability of recovery on the maximum duration antibiotic was found to be equivalent to the probability of recovery on the 1 day, 2 days, 3 days etc arms.

A 5% equivalence margin was used in conjuction with a 60% decision threshold.

```{r, echo = F, eval = T}
digits <- c(0, 1, 0, 0, 0, 0,
            rep(2, n_doses-1)
            )

comparison_names <- paste0(doses[-length(doses)], " days")

kable(dni,
      caption = paste0("Table. Simulation Results (", nrow(dni), " rows)"),
      col.names = c("", "", "doses", "min", "max", "n_per_trt",
                    comparison_names),
      digits = digits) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = F, position = "left",
                font_size = 12,
                latex_options = "hold_position")  %>%
  add_header_above(c("Scenario" = 1, "Range" = 1, 
                     "N"=1, "Dose"=2, 
                     "N" = 1,
    "Max duration versus" = n_doses-1))




```


## Todo

